<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC '-//ibatis.apache.org//DTD Sql Map 2.0//EN' 'http://ibatis.apache.org/dtd/sql-map-2.dtd'> 
<sqlMap namespace="gnrl">

	<typeAlias alias="hashMap" type="java.util.HashMap"/>

	<resultMap id="goodsDetail" class="hashMap">
        <result property="GOODS_CODE"                column="GOODS_CODE"                jdbcType="string" javaType="string"/>
        <result property="GOODS_NM"                  column="GOODS_NM"                  jdbcType="string" javaType="string"/>
        <result property="GOODS_INTRCN"              column="GOODS_INTRCN"              jdbcType="CLOB"   javaType="string"/>
        <result property="DELETE_AT"                 column="DELETE_AT"                 jdbcType="string" javaType="string"/>
        <result property="FILE_CODE"                 column="FILE_CODE"                 jdbcType="string" javaType="string"/>
        <result property="WRITNG_ID"                 column="WRITNG_ID"                 jdbcType="string" javaType="string"/>
        <result property="WRITNG_DE"                 column="WRITNG_DE"                 jdbcType="string" javaType="string"/>
        <result property="UPDT_ID"                   column="UPDT_ID"                   jdbcType="string" javaType="string"/>
        <result property="UPDT_DE"                   column="UPDT_DE"                   jdbcType="string" javaType="string"/>
        <result property="CTY_CODE"                  column="CTY_CODE"                  jdbcType="string" javaType="string"/>
        <result property="CTY_NM"                    column="CTY_NM"                    jdbcType="string" javaType="string"/>
        <result property="UPPER_CL_CODE"             column="UPPER_CL_CODE"             jdbcType="string" javaType="string"/>
        <result property="CL_CODE"                   column="CL_CODE"                   jdbcType="string" javaType="string"/>
        <result property="CL_NM"                     column="CL_NM"                     jdbcType="string" javaType="string"/>
        <result property="WAIT_TIME"                 column="WAIT_TIME"                 jdbcType="string" javaType="string"/>
        <result property="MVMN_TIME"                 column="MVMN_TIME"                 jdbcType="string" javaType="string"/>
        <result property="ACT_LA"                    column="ACT_LA"                    jdbcType="string" javaType="string"/>
        <result property="ACT_LO"                    column="ACT_LO"                    jdbcType="string" javaType="string"/>
        <result property="VOCHR_TICKET_TY"           column="VOCHR_TICKET_TY"           jdbcType="string" javaType="string"/>
        <result property="VOCHR_NTSS_REQRE_TIME"     column="VOCHR_NTSS_REQRE_TIME"     jdbcType="string" javaType="string"/>
        <result property="VOCHR_USE_MTH"             column="VOCHR_USE_MTH"             jdbcType="string" javaType="string"/>
        <result property="GUIDANCE_USE_TIME"         column="GUIDANCE_USE_TIME"         jdbcType="string" javaType="string"/>
        <result property="GUIDANCE_REQRE_TIME"       column="GUIDANCE_REQRE_TIME"       jdbcType="string" javaType="string"/>
        <result property="GUIDANCE_AGE_DIV"          column="GUIDANCE_AGE_DIV"          jdbcType="string" javaType="string"/>
        <result property="GUIDANCE_TOUR_SCHDUL"      column="GUIDANCE_TOUR_SCHDUL"      jdbcType="string" javaType="string"/>
        <result property="GUIDANCE_PRFPLC_LC"        column="GUIDANCE_PRFPLC_LC"        jdbcType="string" javaType="string"/>
        <result property="GUIDANCE_EDC_CRSE"         column="GUIDANCE_EDC_CRSE"         jdbcType="string" javaType="string"/>
        <result property="GUIDANCE_OPTN_MATTER"      column="GUIDANCE_OPTN_MATTER"      jdbcType="string" javaType="string"/>
        <result property="GUIDANCE_PICKUP"           column="GUIDANCE_PICKUP"           jdbcType="string" javaType="string"/>
        <result property="GUIDANCE_PRPARETG"         column="GUIDANCE_PRPARETG"         jdbcType="string" javaType="string"/>
        <result property="GUIDANCE_INCLS_MATTER"     column="GUIDANCE_INCLS_MATTER"     jdbcType="string" javaType="string"/>
        <result property="GUIDANCE_NOT_INCLS_MATTER" column="GUIDANCE_NOT_INCLS_MATTER" jdbcType="string" javaType="string"/>
        <result property="ADIT_GUIDANCE"             column="ADIT_GUIDANCE"             jdbcType="string" javaType="string"/>
        <result property="ATENT_MATTER"              column="ATENT_MATTER"              jdbcType="string" javaType="string"/>
        <result property="CHANGE_REFND_REGLTN"       column="CHANGE_REFND_REGLTN"       jdbcType="string" javaType="string"/>
        <result property="INTRCN_GOODS_TY"           column="INTRCN_GOODS_TY"           jdbcType="string" javaType="string"/>
        <result property="INTRCN_USE_TIME"           column="INTRCN_USE_TIME"           jdbcType="string" javaType="string"/>
        <result property="INTRCN_MEET_TIME"          column="INTRCN_MEET_TIME"          jdbcType="string" javaType="string"/>
        <result property="INTRCN_REQRE_TIME"         column="INTRCN_REQRE_TIME"         jdbcType="string" javaType="string"/>
        <result property="INTRCN_PROVD_LANG"         column="INTRCN_PROVD_LANG"         jdbcType="string" javaType="string"/>
        <result property="INTRCN_POSBL_AGE"          column="INTRCN_POSBL_AGE"          jdbcType="string" javaType="string"/>
        <result property="INTRCN_PLACE"              column="INTRCN_PLACE"              jdbcType="string" javaType="string"/>
        <result property="CL_SE"                     column="CL_SE"                     jdbcType="string" javaType="string"/>
        <result property="SORT_ORDR"                 column="SORT_ORDR"                 jdbcType="string" javaType="string"/>
        <result property="CF_MIN_BEGIN_DE"           column="CF_MIN_BEGIN_DE"           jdbcType="string" javaType="string"/>
        <result property="CF_MAX_END_DE"             column="CF_MAX_END_DE"             jdbcType="string" javaType="string"/>
        <result property="GOODS_INTRCN_SIMPL"        column="GOODS_INTRCN_SIMPL"        jdbcType="string" javaType="string"/>        
        <result property="HOTDEAL_AT"        		 column="HOTDEAL_AT"                jdbcType="string" javaType="string"/>        
        <result property="RECOMEND_AT"        		 column="RECOMEND_AT"               jdbcType="string" javaType="string"/>    
        <result property="TOUR_DAYS"        		 column="TOUR_DAYS"                 jdbcType="string" javaType="string"/>            
        <result property="HOTDEAL_APPLC_BEGIN_DE"    column="HOTDEAL_APPLC_BEGIN_DE"    jdbcType="string" javaType="string"/>            
        <result property="HOTDEAL_APPLC_END_DE"      column="HOTDEAL_APPLC_END_DE"      jdbcType="string" javaType="string"/>            
        <result property="BKMK"        		         column="BKMK"                      jdbcType="string" javaType="string"/>       
        <result property="HOTELSCOMBINE_YN"        	 column="HOTELSCOMBINE_YN"          jdbcType="string" javaType="string"/>       
        <result property="HOTELSCOMBINE_SCRIPT"      column="HOTELSCOMBINE_SCRIPT"      jdbcType="string" javaType="string"/>       
	</resultMap>

	<resultMap id="goodsDetailSub" class="hashMap">
        <result property="GOODS_CODE"                column="GOODS_CODE"                jdbcType="string" javaType="string"/>
        <result property="GOODS_NM"                  column="GOODS_NM"                  jdbcType="string" javaType="string"/>
        <result property="GOODS_INTRCN"              column="GOODS_INTRCN"              jdbcType="CLOB"   javaType="string"/>
        <result property="GOODS_INTRCN_SIMPL"        column="GOODS_INTRCN_SIMPL"        jdbcType="string"   javaType="string"/>
        <result property="FILE_CODE"                  column="FILE_CODE"                  jdbcType="string" javaType="string"/>
        <result property="FILE_SN"                  column="FILE_SN"                  jdbcType="string" javaType="string"/>
	</resultMap>
	
	<sql id="whereList">
		<isNotEmpty property="cty_code">
		   AND G.CTY_CODE = #cty_code#
		</isNotEmpty>
		<isNotEmpty property="cl_code">
		   AND G.CL_CODE = #cl_code#
		</isNotEmpty>
		<isEmpty property="cl_code">
			<isNotEmpty property="upper_cl_code">
				<isEqual property="upper_cl_code" compareValue="H">
					AND G.HOTDEAL_AT = 'Y' AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN G.HOTDEAL_BEGIN_DE AND G.HOTDEAL_END_DE 
				</isEqual>
				<isEqual property="upper_cl_code" compareValue="R">
				   AND G.RECOMEND_AT = 'Y'
				</isEqual>
				<isNotEqual property="upper_cl_code" compareValue="H">
					<isNotEqual property="upper_cl_code" compareValue="R">
						<isNotEqual property="upper_cl_code" compareValue="P">
							<isNotEqual property="upper_cl_code" compareValue="C">
						   		AND G.CL_CODE IN (SELECT CL_CODE FROM TB_TOUR_CL X WHERE X.UPPER_CL_CODE = #upper_cl_code#)
							</isNotEqual>
						</isNotEqual>
					</isNotEqual>
				</isNotEqual>
			</isNotEmpty>
		</isEmpty>
		<isNotEmpty property="keyword">
		   AND G.GOODS_CODE IN
		   		( SELECT GOODS_CODE FROM TB_GOODS_KWRD WHERE
		    <iterate property="keyword" conjunction=" OR ">
		             UPPER(KWRD) LIKE '%' || UPPER(#keyword[]#) || '%'
		    </iterate>
		    	)
		</isNotEmpty>
		<isEqual property="category" compareValue="H">
		   AND G.HOTDEAL_AT = 'Y' AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN G.HOTDEAL_BEGIN_DE AND G.HOTDEAL_END_DE
		</isEqual>
		<isEqual property="category" compareValue="R">
		   AND G.RECOMEND_AT = 'Y'
		</isEqual>	
		<isEqual property="category" compareValue="P">
		   AND G.CL_CODE IN (SELECT CL_CODE FROM TB_TOUR_CL X WHERE X.UPPER_CL_CODE = '00591') 
		</isEqual>
		<isEqual property="category" compareValue="C">
		   AND G.CL_CODE IN (SELECT CL_CODE FROM TB_TOUR_CL X WHERE X.UPPER_CL_CODE = '00412') 
		</isEqual>
		<isEmpty property="user_id">
		   AND NVL(G.PARTICULAR_YN, 'N') = 'N'
		</isEmpty>
		<isNotEmpty property="user_id">
		   AND (NVL(G.PARTICULAR_YN, 'N') = 'N' OR ( PARTICULAR_YN = 'Y' AND EXISTS ( SELECT GOODS_CODE FROM TB_GOODS_USER WHERE GOODS_CODE = G.GOODS_CODE AND USER_ID = #user_id# ) ) )
		</isNotEmpty>
		<isNotEmpty property="date">
		   AND FN_CAN_SCHDUL(G.GOODS_CODE, #date#, #mode#, #date2#) = 'Y'
		</isNotEmpty>
	</sql>

	<select id="gnrl.goods.selectGoodsExpsrList1" parameterClass="hashMap" resultClass="hashMap">
		SELECT HOTDEAL_SN, KWRD, FILE_CODE_L, FILE_CODE_S 
		FROM TB_HOTDEAL
		WHERE USE_AT = 'Y'
		ORDER BY SORT_ORDR		
	</select>
	
	<select id="gnrl.goods.selectGoodsExpsrList2" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.*
		FROM (
				SELECT G.GOODS_CODE, GOODS_NM, GOODS_INTRCN, FILE_CODE, GOODS_INTRCN_SIMPL, GOODS_NM_ENG, GOODS_INTRCN_ENG, GOODS_INTRCN_SIMPL_ENG
					, ( SELECT NVL(MAX(FILE_SN), '') FROM TB_FILE_DETAIL WHERE FILE_CODE = G.FILE_CODE AND RECOMEND_AT = 'Y' ) AS FILE_SN, RNUM
				FROM (
					SELECT GOODS_CODE, ROWNUM AS RNUM
					FROM (		  
						SELECT GOODS_CODE
						FROM TB_GOODS 
						WHERE DELETE_AT = 'N' AND RECOMEND_AT = 'Y' AND RECOMEND_MAIN_AT = 'Y'
						ORDER BY RECOMEND_SORT_ORDR
					)  A		  
				) AA
				INNER JOIN VW_GOODS G ON AA.GOODS_CODE = G.GOODS_CODE
				WHERE AA.RNUM <![CDATA[<=]]> 4
		) A
		RIGHT OUTER JOIN (SELECT LEVEL AS LV FROM DUAL CONNECT BY LEVEL <![CDATA[<=]]> 4) B ON A.RNUM = B.LV
		ORDER BY B.LV
	</select>

	<select id="gnrl.goods.selectGoodsExpsrList3" parameterClass="hashMap" resultClass="hashMap">
				SELECT G.GOODS_CODE, GOODS_NM, GOODS_INTRCN, FILE_CODE, GOODS_INTRCN_SIMPL, GOODS_NM_ENG, GOODS_INTRCN_ENG, GOODS_INTRCN_SIMPL_ENG, GOODS_NM_SUB, GOODS_NM_SUB_ENG
					, ( SELECT NVL(MAX(FILE_SN), '') FROM TB_FILE_DETAIL WHERE FILE_CODE = G.FILE_CODE AND REPRSNT_AT = 'Y' ) AS FILE_SN, RNUM
			     	, (SELECT NVL(ROUND(MIN(X.SETUP_AMOUNT / NVL(X.NMPR_CO, 1)), 0), 0) FROM TB_GOODS_NMPR X WHERE X.DELETE_AT = 'N' AND X.GOODS_CODE = G.GOODS_CODE AND X.PC_REPRSNT_AT = 'Y') ORIGIN_AMOUNT_BAK
			     	, (SELECT DECODE(G.CL_SE, 'S', MIN(X.SETUP_AMOUNT), NVL(MIN(DECODE(X.FIXED_AT, 'Y', NVL(X.SETUP_AMOUNT, 0), NVL(ROUND(X.SETUP_AMOUNT / NVL(X.NMPR_CO, 1), 0), 0))), 0)) FROM TB_GOODS_NMPR X WHERE X.DELETE_AT = 'N' AND X.GOODS_CODE = G.GOODS_CODE AND X.PC_REPRSNT_AT = 'Y') ORIGIN_AMOUNT
			     	, (SELECT NVL(MIN(X.DSCNT_RATE), 1) FROM TB_GOODS_NMPR X WHERE X.DELETE_AT = 'N' AND X.GOODS_CODE = G.GOODS_CODE AND X.PC_REPRSNT_AT = 'Y') DSCNT_RATE
				    , CASE WHEN G.HOTDEAL_AT = 'Y' AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN G.HOTDEAL_BEGIN_DE AND G.HOTDEAL_END_DE THEN 'Y' ELSE 'N' END AS HOTDEAL_AT
				    , G.REPRSNT_PRICE
				FROM (
					SELECT GOODS_CODE, ROWNUM AS RNUM
					FROM (		  
						SELECT X.GOODS_CODE FROM (
						    <!-- SELECT CG.GOODS_CODE, COUNT(CG.CART_SN)
						    FROM TB_PURCHS P
						    INNER JOIN TB_PURCHS_GOODS PG ON PG.PURCHS_SN = P.PURCHS_SN
						    INNER JOIN TB_CART_GOODS CG ON CG.CART_SN = PG.CART_SN AND CG.PURCHS_AT = 'Y'
						    INNER JOIN TB_GOODS G ON G.GOODS_CODE = CG.GOODS_CODE AND G.DELETE_AT = 'N'
						    WHERE P.DELETE_AT = 'N'
						    GROUP BY CG.GOODS_CODE
						    ORDER BY COUNT(CG.CART_SN) DESC -->
						    <!-- 임시 -->
							select a.goods_code, count(1)
							from tb_goods_hit a, tb_goods b
							where sysdate - 7 <![CDATA[<=]]> a.HIT_DT
							and a.goods_code = b.goods_code
							and b.delete_at = 'N'
							group by a.goods_code
							order by count(1) desc
						) X WHERE ROWNUM <![CDATA[<=]]> 20
					)  A		  
				) AA
				INNER JOIN VW_GOODS G ON AA.GOODS_CODE = G.GOODS_CODE
				/*WHERE AA.RNUM <![CDATA[<=]]> 10*/
				ORDER BY AA.RNUM
	</select>

	<select id="gnrl.goods.selectGoodsExpsrList4" resultClass="hashMap">
	<![CDATA[
		SELECT A.*
		FROM (
				SELECT G.GOODS_CODE, GOODS_NM, GOODS_INTRCN, FILE_CODE, GOODS_INTRCN_SIMPL
					, ( SELECT NVL(MAX(FILE_SN), '') FROM TB_FILE_DETAIL WHERE FILE_CODE = G.FILE_CODE AND LIVEVIEW_AT = 'Y' ) AS FILE_SN, RNUM
					, G.VIDEO_URL
				FROM (
					SELECT GOODS_CODE, ROWNUM AS RNUM
					FROM (		  
						SELECT GOODS_CODE
						FROM TB_GOODS 
						WHERE DELETE_AT = 'N'  AND VIDEO_MAIN_EXPSR_AT = 'Y'
						ORDER BY SORT_ORDR
					)  A		  
				) AA
				INNER JOIN TB_GOODS G ON AA.GOODS_CODE = G.GOODS_CODE
				WHERE AA.RNUM <= 5
		) A
		RIGHT OUTER JOIN (SELECT LEVEL AS LV FROM DUAL CONNECT BY LEVEL <= 5) B ON A.RNUM = B.LV
		ORDER BY B.LV
	]]>
	</select>		
	<select id="gnrl.goods.selectUpperTourClMain" parameterClass="hashMap" resultClass="hashMap">
		SELECT CL_CODE
		     , CL_NM
		     , FILE_CODE
		     , DELETE_AT
		     , WRITNG_ID
		     , TO_CHAR(WRITNG_DT,'YYYY-MM-DD') WRITNG_DE 
		     , UPDT_ID
		     , TO_CHAR(UPDT_DT,'YYYY-MM-DD') UPDT_DE
		     , (SELECT COUNT(1) FROM TB_GOODS X WHERE X.CL_CODE = A.CL_CODE) AS GOODS_CNT
		     , SORT_ORDR
		     , DC
		     , DECODE(A.UPPER_CL_CODE, '00000', A.SORT_ORDR*1000, (SELECT B.SORT_ORDR*1000 FROM TB_TOUR_CL B WHERE B.CL_CODE = A.UPPER_CL_CODE)+A.SORT_ORDR) CF_SORT
		     , CL_NM_ENG
		     , DC_ENG
		  FROM TB_TOUR_CL A
		 WHERE DELETE_AT = 'N'
		<isNotEmpty property="upper_cl_code">
		   AND UPPER_CL_CODE = #upper_cl_code#
		</isNotEmpty>
		<isNotEmpty property="cl_code">
		   AND CL_CODE = #cl_code#
		</isNotEmpty>
		<isNotEmpty property="cl_code_arr">
		   AND CL_CODE IN <iterate property="cl_code_arr" open=" (" conjunction="," close=")">#cl_code_arr[]#</iterate>
		</isNotEmpty>
		<isEmpty property="upper_cl_code">
			<isEmpty property="cl_code">
		   AND UPPER_CL_CODE <![CDATA[<>]]> '00000'
			</isEmpty>
		</isEmpty>
		 ORDER BY CF_SORT
	</select>

	<select id="gnrl.goods.selectUpperTourClList" parameterClass="hashMap" resultClass="hashMap">
		SELECT CL_CODE
		     , CL_NM
		     , FILE_CODE
		     , DELETE_AT
		     , WRITNG_ID
		     , TO_CHAR(WRITNG_DT,'YYYY-MM-DD') WRITNG_DE 
		     , UPDT_ID
		     , TO_CHAR(UPDT_DT,'YYYY-MM-DD') UPDT_DE
		     , (SELECT COUNT(1) FROM TB_GOODS X WHERE X.CL_CODE = A.CL_CODE) AS GOODS_CNT
		     , SORT_ORDR
		     , DC
		     , DECODE(A.UPPER_CL_CODE, '00000', A.SORT_ORDR*1000, (SELECT B.SORT_ORDR*1000 FROM TB_TOUR_CL B WHERE B.CL_CODE = A.UPPER_CL_CODE)+A.SORT_ORDR) CF_SORT
		  FROM TB_TOUR_CL A
		 WHERE DELETE_AT = 'N'
		   AND CL_CODE IN ( SELECT G.CL_CODE 
		   					FROM TB_GOODS G
		   					WHERE G.DELETE_AT = 'N' 
				 			<include refid="whereList"/> )	
		 ORDER BY CF_SORT
	</select>
	
	<select id="gnrl.goods.selectGoodsListCount" parameterClass="hashMap" resultClass="Integer">
		SELECT COUNT(1)
		FROM TB_GOODS G
		WHERE G.DELETE_AT = 'N'
		 <include refid="whereList"/>	
	</select>

	<select id="gnrl.goods.selectGoodsList" parameterClass="hashMap" resultClass="hashMap"> 
		SELECT A.GOODS_CODE
			     , A.GOODS_NM
			     , A.GOODS_NM_SUB
			     , A.DELETE_AT
			     , A.FILE_CODE
			     , A.WAIT_TIME
			     , A.MVMN_TIME
			     , A.FILE_CODE
			     , A.CTY_CODE
			     , (SELECT CTY_NM FROM TB_CTY X WHERE X.CTY_CODE = A.CTY_CODE) CTY_NM
			     , A.CL_CODE
			     , (SELECT CL_NM FROM TB_TOUR_CL X WHERE X.CL_CODE = A.CL_CODE) CL_NM
			     , (SELECT CL_NM_ENG FROM TB_TOUR_CL X WHERE X.CL_CODE = A.CL_CODE) CL_NM_ENG
			     , (SELECT CL_CODE FROM TB_TOUR_CL X WHERE X.UPPER_CL_CODE = '00000' START WITH X.CL_CODE = A.CL_CODE CONNECT BY PRIOR UPPER_CL_CODE = CL_CODE) UPPER_CL_CODE
			     , (SELECT CL_NM FROM TB_TOUR_CL X WHERE X.UPPER_CL_CODE = '00000' START WITH X.CL_CODE = A.CL_CODE CONNECT BY PRIOR UPPER_CL_CODE = CL_CODE) UPPER_CL_NM
			     , (SELECT CL_NM_ENG FROM TB_TOUR_CL X WHERE X.UPPER_CL_CODE = '00000' START WITH X.CL_CODE = A.CL_CODE CONNECT BY PRIOR UPPER_CL_CODE = CL_CODE) UPPER_CL_NM_ENG
			     , A.CTY_CODE
			     , (SELECT CTY_NM_ENG FROM TB_CTY X WHERE X.CTY_CODE = A.CTY_CODE) CTY_NM_ENG
			     , COUNT(A.GOODS_CODE) OVER() AS TOT_CNT
			     , (SELECT NVL(ROUND(MIN(X.SETUP_AMOUNT / NVL(X.NMPR_CO, 1)), 0), 0) FROM TB_GOODS_NMPR X WHERE X.DELETE_AT = 'N' AND X.GOODS_CODE = A.GOODS_CODE AND X.PC_REPRSNT_AT = 'Y') CF_REPRSNT_AMOUNT_BAK
			     , (SELECT DECODE(G.CL_SE, 'S', MIN(X.SETUP_AMOUNT), NVL(MIN(DECODE(X.FIXED_AT, 'Y', X.SETUP_AMOUNT, ROUND(X.SETUP_AMOUNT / NVL(X.NMPR_CO, 1), 0))), 0)) FROM TB_GOODS_NMPR X WHERE X.DELETE_AT = 'N' AND X.GOODS_CODE = A.GOODS_CODE AND X.PC_REPRSNT_AT = 'Y') CF_REPRSNT_AMOUNT
			     , (SELECT NVL(MIN(X.DSCNT_RATE), 1) FROM TB_GOODS_NMPR X WHERE X.DELETE_AT = 'N' AND X.GOODS_CODE = A.GOODS_CODE AND X.PC_REPRSNT_AT = 'Y') DSCNT_RATE
			     , (SELECT TO_CHAR(NVL(MIN(X.SETUP_AMOUNT), 0), 'FM9,999,999') FROM TB_GOODS_NMPR X WHERE X.DELETE_AT = 'N' AND X.GOODS_CODE = A.GOODS_CODE) CF_MIN_AMOUNT
			     , (SELECT NVL(MIN(X.SETUP_AMOUNT), 0) FROM TB_GOODS_NMPR X WHERE X.DELETE_AT = 'N' AND X.GOODS_CODE = A.GOODS_CODE) MIN_AMOUNT
			     , (SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END FROM TB_BKMK WHERE ESNTL_ID = #esntl_id# AND GOODS_CODE = A.GOODS_CODE) BKMK
			     , CASE WHEN A.HOTDEAL_AT = 'Y' AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN A.HOTDEAL_BEGIN_DE AND A.HOTDEAL_END_DE THEN 'Y' ELSE 'N' END AS HOTDEAL_AT
			     , A.RECOMEND_AT
			     , A.GOODS_NM_ENG
			     , A.GOODS_NM_SUB_ENG
			     , A.REPRSNT_PRICE
		FROM (
			SELECT GOODS_CODE, CL_SE, ROWNUM AS RNUM
			FROM (
				SELECT B.GOODS_CODE, CL_SE, ROWNUM AS RNUM
				FROM (
					SELECT G.GOODS_CODE, G.CL_SE
					FROM TB_GOODS G
					WHERE G.DELETE_AT = 'N' 
					<include refid="whereList"/>
					<isNotEmpty property="sortOrd">
						<isEqual property="sortOrd" compareValue="L">
							ORDER BY 2, G.GOODS_NM
						</isEqual>
						<isEqual property="sortOrd" compareValue="H">
							ORDER BY 2 DESC, G.GOODS_NM
						</isEqual>
					</isNotEmpty>
					<isEmpty property="sortOrd">
						<isEqual property="upper_cl_code" compareValue="H">
							 	ORDER BY G.HOTDEAL_SORT_ORDR, G.GOODS_NM
						</isEqual>
						<isEqual property="upper_cl_code" compareValue="R">
							 	ORDER BY G.RECOMEND_SORT_ORDR, G.GOODS_NM
						</isEqual>
						<isNotEqual property="upper_cl_code" compareValue="H">
							<isNotEqual property="upper_cl_code" compareValue="R">
							 	ORDER BY G.SORT_ORDR, G.GOODS_NM
							</isNotEqual>
						</isNotEqual>
					</isEmpty>
				) B
			) AA
			WHERE RNUM BETWEEN #startIdx# AND #endIdx#
		) G
		INNER JOIN VW_GOODS A ON G.GOODS_CODE = A.GOODS_CODE
		ORDER BY G.RNUM
	</select>

	<select id="gnrl.goods.selectGoodsDetail" parameterClass="hashMap" resultMap="goodsDetail"> 
	<![CDATA[	
        SELECT GOODS_CODE
             , GOODS_NM
             , REPLACE(REPLACE(REPLACE(GOODS_INTRCN,CHR(10),'<BR>'),CHR(13),' '), '  ', CHR(38)||'nbsp;'||CHR(38)||'nbsp;') GOODS_INTRCN
             , DELETE_AT
             , FILE_CODE
             , WRITNG_ID
             , TO_CHAR(WRITNG_DT,'YYYY-MM-DD') WRITNG_DE
             , UPDT_ID
             , TO_CHAR(UPDT_DT,'YYYY-MM-DD') UPDT_DE
             , WAIT_TIME
             , MVMN_TIME
             , ACT_LA
             , ACT_LO
		     , CTY_CODE
		     , (SELECT CTY_NM FROM TB_CTY X WHERE X.CTY_CODE = A.CTY_CODE) CTY_NM
             , (SELECT UPPER_CL_CODE FROM TB_TOUR_CL X WHERE X.CL_CODE = A.CL_CODE) UPPER_CL_CODE
             , CL_CODE
             , (SELECT C.CL_NM FROM TB_TOUR_CL C WHERE A.CL_CODE = C.CL_CODE) CL_NM
             , CL_SE
             , SORT_ORDR
             , VOCHR_TICKET_TY
             , VOCHR_NTSS_REQRE_TIME
             , FN_CONVERT_BR(VOCHR_USE_MTH            ) VOCHR_USE_MTH
             , FN_CONVERT_BR(GUIDANCE_USE_TIME        ) GUIDANCE_USE_TIME
             , FN_CONVERT_BR(GUIDANCE_REQRE_TIME      ) GUIDANCE_REQRE_TIME
             , FN_CONVERT_BR(GUIDANCE_AGE_DIV         ) GUIDANCE_AGE_DIV
             , FN_CONVERT_BR(GUIDANCE_TOUR_SCHDUL     ) GUIDANCE_TOUR_SCHDUL
             , FN_CONVERT_BR(GUIDANCE_PRFPLC_LC       ) GUIDANCE_PRFPLC_LC
             , FN_CONVERT_BR(GUIDANCE_EDC_CRSE        ) GUIDANCE_EDC_CRSE
             , FN_CONVERT_BR(GUIDANCE_OPTN_MATTER     ) GUIDANCE_OPTN_MATTER
             , FN_CONVERT_BR(GUIDANCE_PICKUP          ) GUIDANCE_PICKUP
             , FN_CONVERT_BR(GUIDANCE_PRPARETG        ) GUIDANCE_PRPARETG
             , FN_CONVERT_BR(GUIDANCE_INCLS_MATTER    ) GUIDANCE_INCLS_MATTER
             , FN_CONVERT_BR(GUIDANCE_NOT_INCLS_MATTER) GUIDANCE_NOT_INCLS_MATTER
             , FN_CONVERT_BR(ADIT_GUIDANCE            ) ADIT_GUIDANCE
             , FN_CONVERT_BR(ATENT_MATTER             ) ATENT_MATTER
             , FN_CONVERT_BR(CHANGE_REFND_REGLTN      ) CHANGE_REFND_REGLTN
             , INTRCN_GOODS_TY
             , INTRCN_USE_TIME
             , INTRCN_MEET_TIME
             , INTRCN_REQRE_TIME
             , INTRCN_PROVD_LANG
             , INTRCN_POSBL_AGE
             , INTRCN_PLACE
             , (SELECT TO_CHAR(NVL(TO_DATE(MIN(BEGIN_DE), 'YYYYMMDD'), SYSDATE), 'YYYY-MM-DD') FROM TB_GOODS_SCHDUL X WHERE X.DELETE_AT = 'N' AND  X.GOODS_CODE = A.GOODS_CODE) CF_MIN_BEGIN_DE             
             , (SELECT TO_CHAR(TO_DATE(MAX(END_DE), 'YYYYMMDD'), 'YYYY-MM-DD') FROM TB_GOODS_SCHDUL X WHERE X.DELETE_AT = 'N' AND  X.GOODS_CODE = A.GOODS_CODE) CF_MAX_END_DE
             , FN_CONVERT_BR(GOODS_INTRCN_SIMPL) GOODS_INTRCN_SIMPL                     
             , CASE WHEN A.HOTDEAL_AT = 'Y' AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN A.HOTDEAL_BEGIN_DE AND A.HOTDEAL_END_DE THEN 'Y' ELSE 'N' END AS HOTDEAL_AT
             , RECOMEND_AT     
             , TOUR_DAYS
             , HOTDEAL_APPLC_BEGIN_DE
             , HOTDEAL_APPLC_END_DE
		     , (SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END FROM TB_BKMK WHERE ESNTL_ID = #esntl_id# AND GOODS_CODE = A.GOODS_CODE) BKMK
		     , HOTELSCOMBINE_YN
		     , HOTELSCOMBINE_SCRIPT
          FROM TB_GOODS A 
         WHERE GOODS_CODE = #goods_code# ]]>
		<isEmpty property="admin_at">
           AND DELETE_AT = 'N'
		</isEmpty>          
	</select>

	<select id="gnrl.goods.selectGoodsSchdulList" parameterClass="hashMap" resultClass="hashMap">
		SELECT BEGIN_DE, END_DE, NVL(POSBL_AT, 'Y') AS POSBL_AT
		  FROM TB_GOODS_SCHDUL GS
		 WHERE DELETE_AT = 'N'
		   AND GOODS_CODE = #goods_code#
		 ORDER BY BEGIN_DE ASC
	</select>

	<select id="gnrl.goods.selectGoodsNmprList" parameterClass="hashMap" resultClass="hashMap"> 
		SELECT GN.GOODS_CODE
		     , GN.SETUP_SE
		     , GN.NMPR_SN
		     , GN.NMPR_CND
		     , GN.FIXED_AT
		     , GN.SETUP_AMOUNT
		     , GN.SETUP_RATE
		     , NVL(GN.NMPR_CO, 1) AS NMPR_CO
		     , GN.MAX_NMPR_CO
		     , GN.ADIT_NMPR_AMOUNT
		     , NVL(GN.DSCNT_RATE, 1) AS DSCNT_RATE
		     , GN.CO_UNIT_SE
		     , C.CODE_NM AS OPTION_NM
		     , C.CODE_NM AS UNIT_NM
		  FROM TB_GOODS_NMPR GN
		  		LEFT OUTER JOIN TB_CMMN_DETAIL_CODE C ON GN.CO_UNIT_SE = C.CODE AND C.CODE_ID = 'COM008'
		 WHERE GN.DELETE_AT = 'N'
		   AND GN.GOODS_CODE = #goods_code#
		 ORDER BY GN.SORT_ORDR
	</select>
	
	<select id="gnrl.goods.selectGoodsNmprBySetupSeList" parameterClass="hashMap" resultClass="hashMap">
		SELECT GN.GOODS_CODE
		     , GN.SETUP_SE
		     , GN.NMPR_SN
		     , GN.NMPR_CND
		     , GN.FIXED_AT
		     , GN.SETUP_AMOUNT
		     , GN.SETUP_RATE
		     , NVL(GN.NMPR_CO, 1) AS NMPR_CO
		     , GN.MAX_NMPR_CO
		     , GN.ADIT_NMPR_AMOUNT
		     , NVL(GN.DSCNT_RATE, 1) AS DSCNT_RATE
		     , GN.CO_UNIT_SE
		     , C.CODE_NM AS OPTION_NM
		     , C.CODE_NM AS UNIT_NM
		  FROM TB_GOODS_NMPR GN
		  		LEFT OUTER JOIN TB_CMMN_DETAIL_CODE C ON GN.CO_UNIT_SE = C.CODE AND C.CODE_ID = 'COM008'
		 WHERE GN.DELETE_AT = 'N'
		   AND GN.GOODS_CODE = #goods_code#
		   AND GN.SETUP_SE = #setup_se# 
		 ORDER BY GN.SORT_ORDR
	</select>	

	<select id="gnrl.goods.selectGoodsTimeList" parameterClass="hashMap" resultClass="hashMap">
		SELECT TIME_SN
		     , BEGIN_TIME
		     , END_TIME, BEGIN_TIME||END_TIME TOUR_TIME
		  FROM TB_GOODS_TIME GT
		 WHERE DELETE_AT = 'N'
		   AND GOODS_CODE = #goods_code#
		 ORDER BY BEGIN_TIME
	</select>
	
	<select id="gnrl.goods.getReviewScore" parameterClass="hashMap" resultClass="hashMap">
		SELECT NVL(CEIL(AVG(REVIEW_SCORE)), 0) AS CEIL_REVIEW_SCORE, TO_CHAR(NVL(AVG(REVIEW_SCORE), 0), 'FM999990.0') AS REVIEW_SCORE, COUNT(1) REVIEW_COUNT FROM TB_PURCHS_REVIEW
		WHERE GOODS_CODE = #goods_code# AND DELETE_AT = 'N'
	</select>
	
	<select id="gnrl.goods.getReviewCount" parameterClass="hashMap" resultClass="Integer">
		SELECT COUNT(1) FROM TB_PURCHS_REVIEW
		WHERE GOODS_CODE = #goods_code# AND DELETE_AT = 'N'
	</select>
	
	<select id="gnrl.goods.getReview" parameterClass="hashMap" resultClass="hashMap">
		SELECT PR.REVIEW_CN, PR.REVIEW_SCORE, TO_CHAR(PR.WRITNG_DT, 'YYYY-MM-DD') AS WRITNG_DT, U.USER_NM
		FROM (
			SELECT PURCHS_SN, CART_SN, ROWNUM AS RNUM
			FROM (
				SELECT PURCHS_SN, CART_SN FROM TB_PURCHS_REVIEW
				WHERE GOODS_CODE = #goods_code# AND DELETE_AT = 'N'
				ORDER BY WRITNG_DT DESC
			) A
		) B
		INNER JOIN TB_PURCHS_REVIEW PR ON B.PURCHS_SN = PR.PURCHS_SN AND B.CART_SN = PR.CART_SN
		INNER JOIN TB_USER U ON PR.ESNTL_ID = U.ESNTL_ID
		WHERE RNUM BETWEEN #startIdx# AND #endIdx#
		ORDER BY B.RNUM	
	</select>	

	<select id="gnrl.goods.getReservationDt" parameterClass="hashMap" resultClass="hashMap">
	<![CDATA[	
		SELECT RESERVATIONDT, SETUP_SE 
		FROM TB_GOODS_RSV_DAY
		WHERE GOODS_CODE = #goods_code# AND TO_CHAR(SYSDATE, 'YYYYMMDD') <= RESERVATIONDT
		ORDER BY RESERVATIONDT	
	]]>
	</select>
	
</sqlMap>