<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC '-//ibatis.apache.org//DTD Sql Map 2.0//EN' 'http://ibatis.apache.org/dtd/sql-map-2.dtd'> 
<sqlMap namespace="gnrl">

	<resultMap id="goodsDetail" class="java.util.HashMap">
		<result property="GOODS_CODE" column="GOODS_CODE" jdbcType="string" javaType="string"/>
		<result property="GOODS_NM" column="GOODS_NM" jdbcType="string" javaType="string"/>
		<result property="GOODS_INTRCN" column="GOODS_INTRCN" javaType="String" jdbcType="CLOB"/>
		<result property="DELETE_AT" column="DELETE_AT" jdbcType="string" javaType="string"/>
		<result property="FILE_CODE" column="FILE_CODE" jdbcType="string" javaType="string"/>
		<result property="WAIT_TIME" column="WAIT_TIME" jdbcType="string" javaType="string"/>
		<result property="MVMN_TIME" column="MVMN_TIME" jdbcType="string" javaType="string"/>
		<result property="WRITNG_ID" column="WRITNG_ID" jdbcType="string" javaType="string"/>
		<result property="WRITNG_DE" column="WRITNG_DE" jdbcType="string" javaType="string"/>
		<result property="UPDT_ID" column="UPDT_ID" jdbcType="string" javaType="string"/>
		<result property="UPDT_DE" column="UPDT_DE" jdbcType="string" javaType="string"/>
		<result property="ACT_LA" column="ACT_LA" jdbcType="string" javaType="string"/>
		<result property="ACT_LO" column="ACT_LO" jdbcType="string" javaType="string"/>
	</resultMap>

	<select id="gnrl.goods.selectTourClStayng" parameterClass="java.util.HashMap" resultClass="java.lang.String">
		SELECT SUBSTR(XMLAGG(XMLELEMENT( X, '@' , CL_CODE ) ORDER BY CL_NM).EXTRACT('//text()'),2) STAYNG_CL_CODE
		  FROM TB_TOUR_CL  
		 WHERE DELETE_AT = 'N'
		   AND STAYNG_FCLTY_AT = 'Y'   
	</select>

	<select id="gnrl.goods.selectTourClMain" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT 1 CF_SORT
		     , ROW_NUMBER() OVER(ORDER BY CL_NM) CF_ROW
		     , 'XXXXX' CL_CODE
		     , '숙박시설' CL_NM
		     , FILE_CODE
		     , DELETE_AT
		     , WRITNG_ID
		     , TO_CHAR(WRITNG_DT,'YYYY-MM-DD') WRITNG_DE
		     , UPDT_ID
		     , TO_CHAR(UPDT_DT,'YYYY-MM-DD') UPDT_DE
		     , (SELECT COUNT(*) FROM TB_GOODS TG WHERE TG.CL_CODE = CL_CODE) AS GOODS_CNT
		     , STAYNG_FCLTY_AT
		  FROM TB_TOUR_CL
		 WHERE DELETE_AT = 'N'
		   AND STAYNG_FCLTY_AT = 'Y'
		   AND ROWNUM = 1
		 UNION ALL
		SELECT 2 CF_SORT
		     , ROW_NUMBER() OVER(ORDER BY CL_NM) CF_ROW
		     , CL_CODE
		     , CL_NM
		     , FILE_CODE
		     , DELETE_AT
		     , WRITNG_ID
		     , TO_CHAR(WRITNG_DT,'YYYY-MM-DD') WRITNG_DE
		     , UPDT_ID
		     , TO_CHAR(UPDT_DT,'YYYY-MM-DD') UPDT_DE
		     , (SELECT COUNT(*) FROM TB_GOODS TG WHERE TG.CL_CODE = CL_CODE) AS GOODS_CNT
		     , STAYNG_FCLTY_AT
		  FROM TB_TOUR_CL
		 WHERE DELETE_AT = 'N'
		   AND STAYNG_FCLTY_AT = 'N'
		 ORDER BY CF_SORT, CF_ROW ASC
	</select> 

	<select id="gnrl.goods.selectTourClList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap"> 
		SELECT  
		TT.CL_CODE,
		TT.CL_NM,
		TT.FILE_CODE,
		TT.DELETE_AT,
		TT.WRITNG_ID,
		TO_CHAR(TT.WRITNG_DT,'YYYY-MM-DD') WRITNG_DE,
		TT.UPDT_ID,
		TO_CHAR(TT.UPDT_DT,'YYYY-MM-DD') UPDT_DE,
		(SELECT COUNT(*) FROM TB_GOODS TG WHERE TG.CL_CODE = TT.CL_CODE) AS GOODS_CNT
		FROM TB_TOUR_CL TT
		WHERE TT.DELETE_AT = 'N'
	    <isEqual property="stayng_fclty_at" compareValue="Y" prepend="AND">
	    	TT.STAYNG_FCLTY_AT = #stayng_fclty_at#
	    </isEqual>
	    <isNotEmpty property="cl_code_arr" prepend="AND">
			TT.CL_CODE IN
			<iterate property="cl_code_arr" open=" (" conjunction="," close=")">
				#cl_code_arr[]#
			</iterate>
		</isNotEmpty>
		ORDER BY TT.CL_NM ASC	
	</select>

	<select id="gnrl.goods.selectTourClDetail" parameterClass="java.util.HashMap" resultClass="java.util.HashMap"> 
		SELECT  
		TT.CL_CODE,
		TT.CL_NM,
		TT.FILE_CODE,
		TT.DELETE_AT,
		TT.WRITNG_ID,
		TO_CHAR(TT.WRITNG_DT,'YYYY-MM-DD') WRITNG_DE,
		TT.UPDT_ID,
		TO_CHAR(TT.UPDT_DT,'YYYY-MM-DD') UPDT_DE,
		<!-- (SELECT COUNT(*) FROM TB_GOODS_CL TG WHERE TG.CL_CODE = TT.CL_CODE) AS GOODS_CNT -->
		(SELECT COUNT(*) FROM TB_GOODS TG WHERE TG.CL_CODE = TT.CL_CODE) AS GOODS_CNT
		FROM TB_TOUR_CL TT
		WHERE TT.DELETE_AT = 'N'
		AND TT.CL_CODE = #cl_code#
	</select>

	<select id="gnrl.goods.selectGoodsList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap"> 
		SELECT 
		X.RN, 
		X.TOT_CNT,
		X.GOODS_CODE,
		X.GOODS_NM,
		X.DELETE_AT,
		X.FILE_CODE,
		X.WAIT_TIME,
		X.MVMN_TIME,
		X.WRITNG_ID,
		X.WRITNG_DE,
		X.UPDT_ID,
		X.UPDT_DE,
		FN_CL_LIST(X.GOODS_CODE) AS CL_LIST,
		FN_SCHDUL_LIST(X.GOODS_CODE) AS SCHDUL_LIST
		FROM 
		(
			SELECT A.*, 
			ROWNUM AS RN, COUNT(*) OVER() AS TOT_CNT
			FROM 
			(
				SELECT  
				TG.GOODS_CODE,
				TG.GOODS_NM,
				TG.DELETE_AT,
				TG.FILE_CODE,
				TG.WAIT_TIME,
				TG.MVMN_TIME,
				TG.WRITNG_ID,
				TO_CHAR(TG.WRITNG_DT,'YYYY-MM-DD') WRITNG_DE,
				TG.UPDT_ID,
				TO_CHAR(TG.UPDT_DT,'YYYY-MM-DD') UPDT_DE
				FROM TB_GOODS TG
				WHERE TG.DELETE_AT = 'N'
				AND TG.CL_CODE = #cl_code#
				<!-- 20170809 
				AND EXISTS (
				    SELECT * FROM TB_GOODS_CL TGC
				    WHERE TGC.GOODS_CODE = TG.GOODS_CODE
				    AND TGC.CL_CODE = #cl_code# -->
				    <!-- 20170801 
				    <isNotEmpty property="cl_code_arr" prepend="AND">
						TGC.CL_CODE IN
						<iterate property="cl_code_arr" open=" (" conjunction="," close=")">
							#cl_code_arr[]#
						</iterate>
					</isNotEmpty> -->
				<!-- 20170809 ) -->
				ORDER BY TG.WRITNG_DT DESC		
			) A	
		) X
		WHERE (RN <![CDATA[ > ]]> #startRow# AND RN <![CDATA[ <= ]]> #endRow#)
		ORDER BY RN ASC
	</select>

	<select id="gnrl.goods.selectGoodsDetail" parameterClass="java.util.HashMap" resultMap="goodsDetail"> 
		SELECT  
			TG.GOODS_CODE,
			TG.GOODS_NM,
			TG.GOODS_INTRCN,
			TG.DELETE_AT,
			TG.FILE_CODE,
			TG.WAIT_TIME,
			TG.MVMN_TIME,		
			TG.WRITNG_ID,
			TO_CHAR(TG.WRITNG_DT,'YYYY-MM-DD') WRITNG_DE,
			TG.UPDT_ID,
			TO_CHAR(TG.UPDT_DT,'YYYY-MM-DD') UPDT_DE,
			NVL(TG.ACT_LA, 37.612579) ACT_LA,
			NVL(TG.ACT_LO, 126.974806) ACT_LO
		FROM TB_GOODS TG
		WHERE TG.DELETE_AT = 'N'
		AND TG.GOODS_CODE = #goods_code#
	</select>

	<select id="gnrl.goods.selectGoodsClList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
        SELECT TC.CL_CODE, TC.CL_NM, TC.STAYNG_FCLTY_AT
        FROM TB_GOODS GC
        INNER JOIN TB_TOUR_CL TC ON GC.CL_CODE = TC.CL_CODE
        WHERE GC.GOODS_CODE = #goods_code#
        ORDER BY TC.CL_NM ASC
	</select>

	<select id="gnrl.goods.selectGoodsSchdulList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
        SELECT GS.BEGIN_DE, GS.END_DE, 
        SUBSTR(GS.BEGIN_DE,1,4) ||'-'|| SUBSTR(GS.BEGIN_DE,5,2) ||'-'|| SUBSTR(GS.BEGIN_DE,7,2) AS BEGIN_CAL_DE,
        SUBSTR(GS.END_DE,1,4) ||'-'|| SUBSTR(GS.END_DE,5,2) ||'-'|| SUBSTR(GS.END_DE,7,2) AS END_CAL_DE
        FROM TB_GOODS_SCHDUL GS
        WHERE GS.GOODS_CODE = #goods_code#
        AND GS.DELETE_AT = 'N'
        ORDER BY GS.BEGIN_DE ASC
	</select>

	<select id="gnrl.goods.selectGoodsNmprList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT GN.NMPR_SN, GN.NMPR_CND, GN.SETUP_AMOUNT
		FROM TB_GOODS_NMPR GN
		WHERE GN.DELETE_AT = 'N'
		AND GN.GOODS_CODE = #goods_code#
		ORDER BY GN.NMPR_SN ASC
	</select>
	<select id="gnrl.goods.selectGoodsTimeList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT GT.TIME_SN, GT.BEGIN_TIME, GT.END_TIME, GT.BEGIN_TIME||GT.END_TIME TOUR_TIME
		FROM TB_GOODS_TIME GT
		WHERE GT.DELETE_AT = 'N'
		AND GT.GOODS_CODE = #goods_code#
		ORDER BY GT.BEGIN_TIME
	</select>	
</sqlMap>