<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC '-//ibatis.apache.org//DTD Sql Map 2.0//EN' 'http://ibatis.apache.org/dtd/sql-map-2.dtd'> 
<sqlMap namespace="gnrl">

	<resultMap id="cartDetail" class="java.util.HashMap">
		<result property="CART_SN" column="CART_SN" columnIndex="1"/>
		<result property="GOODS_CODE" column="GOODS_CODE" columnIndex="2"/>
		<result property="NMPR_SN" column="NMPR_SN" columnIndex="3"/>
		<result property="PURCHS_AMOUNT" column="PURCHS_AMOUNT" columnIndex="4"/>
		<result property="TOUR_DE" column="TOUR_DE" columnIndex="5"/>
		<result property="GOODS_NM" column="GOODS_NM" columnIndex="6"/>
		<result property="GOODS_INTRCN" column="GOODS_INTRCN" columnIndex="7" javaType="String" jdbcType="CLOB"/>
		<result property="FILE_CODE" column="FILE_CODE" columnIndex="8"/>
		<result property="NMPR_CND" column="NMPR_CND" columnIndex="9"/>
		<result property="SETUP_AMOUNT" column="SETUP_AMOUNT" columnIndex="10"/>
		<result property="WRITNG_ID" column="WRITNG_ID" columnIndex="11"/>
		<result property="WRITNG_DE" column="WRITNG_DE" columnIndex="12"/>
	</resultMap>

	<select id="gnrl.cart.selectCartList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap"> 
		SELECT 
		X.RN, 
		X.TOT_CNT,
		X.CART_SN, 
		X.GOODS_CODE, 
		X.NMPR_SN, 
		X.PURCHS_AMOUNT, 
		X.TOUR_DE,
		X.GOODS_NM, 
		X.FILE_CODE,
		X.NMPR_CND, 
		X.SETUP_AMOUNT,
		X.WRITNG_ID,
		X.WRITNG_DE
		FROM 
		(
			SELECT A.*, 
			ROWNUM AS RN, COUNT(*) OVER() AS TOT_CNT
			FROM 
			(
				SELECT 
				CG.CART_SN, 
				CG.GOODS_CODE, 
				CG.NMPR_SN, 
				CG.PURCHS_AMOUNT, 
				CG.TOUR_DE,
				G.GOODS_NM, 
				G.FILE_CODE,
				GN.NMPR_CND, 
				GN.SETUP_AMOUNT,
				CG.WRITNG_ID,
				CG.WRITNG_DE
				FROM TB_CART_GOODS CG
				INNER JOIN TB_GOODS G ON G.GOODS_CODE = CG.GOODS_CODE AND G.DELETE_AT = 'N'
				INNER JOIN TB_GOODS_NMPR GN ON GN.GOODS_CODE = CG.GOODS_CODE AND GN.NMPR_SN = CG.NMPR_SN AND GN.DELETE_AT = 'N'
				WHERE CG.ESNTL_ID = #esntl_id#
				AND CG.EXPRTN_AT = 'N'
				ORDER BY CG.WRITNG_DE DESC		
			) A	
		) X
		WHERE (RN <![CDATA[ > ]]> #startRow# AND RN <![CDATA[ <= ]]> #endRow#)
		ORDER BY RN ASC
	</select>

	<select id="gnrl.cart.selectCartDetail" parameterClass="java.util.HashMap" resultMap="cartDetail"> 
		SELECT 
		CG.CART_SN, 
		CG.GOODS_CODE, 
		CG.NMPR_SN, 
		CG.PURCHS_AMOUNT, 
		CG.TOUR_DE,
		G.GOODS_NM, 
		G.GOODS_INTRCN,
		G.FILE_CODE,
		GN.NMPR_CND, 
		GN.SETUP_AMOUNT,
		CG.WRITNG_ID,
		CG.WRITNG_DE
		FROM TB_CART_GOODS CG
		INNER JOIN TB_GOODS G ON G.GOODS_CODE = CG.GOODS_CODE AND G.DELETE_AT = 'N'
		INNER JOIN TB_GOODS_NMPR GN ON GN.GOODS_CODE = CG.GOODS_CODE AND GN.NMPR_SN = CG.NMPR_SN AND GN.DELETE_AT = 'N'
		WHERE CG.ESNTL_ID = #esntl_id# AND CG.CART_SN = #cart_sn#
		AND CG.EXPRTN_AT = 'N'		
	</select>

	<select id="gnrl.cart.selectCartValidCnfirm" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT 
		G.GOODS_NM, GN.NMPR_CND, GN.SETUP_AMOUNT
		FROM TB_GOODS G
		INNER JOIN TB_GOODS_NMPR GN ON GN.GOODS_CODE = G.GOODS_CODE AND GN.DELETE_AT = 'N'
		INNER JOIN TB_GOODS_SCHDUL GS ON GS.GOODS_CODE = G.GOODS_CODE AND GS.DELETE_AT = 'N'
		WHERE G.DELETE_AT = 'N'
		AND G.GOODS_CODE = #goods_code#
		AND GN.NMPR_SN = #nmpr_sn#
		AND #tour_de# BETWEEN GS.BEGIN_DE AND GS.END_DE
	</select>

	<insert id="gnrl.cart.insertCart" parameterClass="HashMap">

		<selectKey resultClass="int" keyProperty="cart_sn" >
			SELECT NVL(MAX(CART_SN)+1, 1) FROM TB_CART_GOODS WHERE ESNTL_ID = #esntl_id#
		</selectKey>

		INSERT INTO TB_CART_GOODS(
			ESNTL_ID,
			CART_SN,
			GOODS_CODE,
			NMPR_SN,
			PURCHS_AMOUNT,
			TOUR_DE,
			EXPRTN_AT,
			WRITNG_ID,
			WRITNG_DE
		) VALUES(
			#esntl_id#,
			#cart_sn#,
			#goods_code#,
			#nmpr_sn#,
			(SELECT SETUP_AMOUNT FROM TB_GOODS_NMPR WHERE GOODS_CODE = #goods_code# AND NMPR_SN = #nmpr_sn#),
			#tour_de#,
			'N',
			#esntl_id#,
			TO_CHAR(SYSDATE,'yyyymmdd')
		)
	</insert>	
</sqlMap>