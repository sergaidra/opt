<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="admin">
	<typeAlias alias="hashMap" type="java.util.HashMap"/>
	<typeAlias alias="string" type="java.lang.String"/>

	<sql id="PurchsDAO.pagingQueryStart">
	  SELECT TT.* FROM (
	</sql>

	<sql id="PurchsDAO.pagingQueryEnd">
	  ) TT WHERE ROWSEQ BETWEEN #start# + 1 AND #page# * #limit#
	</sql>

	<sql id="PurchsDAO.whereForSelectPurchsList">
		 WHERE A.PURCHS_DE BETWEEN REPLACE(#FR_PURCHS_DE#, '-', '') AND REPLACE(#TO_PURCHS_DE#, '-', '')
		<isNotEmpty property="ESNTL_ID">
		   AND A.ESNTL_ID = #ESNTL_ID#
		</isNotEmpty>
		<isNotEmpty property="PYMNT_SE">
		   AND A.PYMNT_SE = #PYMNT_SE#
		</isNotEmpty>
		<isNotEmpty property="DELETE_AT">
		   AND A.DELETE_AT = #DELETE_AT#
		</isNotEmpty>
	</sql>

	<select id="PurchsDAO.selectPurchsListCount" parameterClass="hashMap" resultClass="java.lang.Integer">
		SELECT COUNT(PURCHS_SN)
		  FROM TB_PURCHS A
		<include refid="PurchsDAO.whereForSelectPurchsList"/>
	</select>

	<select id="PurchsDAO.selectPurchsList" parameterClass="hashMap" resultClass="hashMap">
		<include refid="PurchsDAO.pagingQueryStart"/><![CDATA[
		SELECT ROW_NUMBER() OVER(ORDER BY A.PURCHS_SN DESC) AS ROWSEQ
		     , A.PURCHS_SN
		     , A.ESNTL_ID
		     , (SELECT X.USER_NM FROM TB_USER X WHERE X.ESNTL_ID = A.ESNTL_ID) USER_NM
		     , SUBSTR(A.PURCHS_DE, 1, 4)||'-'||SUBSTR(A.PURCHS_DE, 5, 2)||'-'||SUBSTR(A.PURCHS_DE, 7, 2) PURCHS_DE
		     , TO_CHAR(A.WRITNG_DT, 'YYYY-MM-DD HH24:MI:SS') PURCHS_DT
		     , TO_CHAR(A.WRITNG_DT, 'HH24:MI:SS') PURCHS_TM
		     , A.TOT_SETLE_AMOUNT
		     , A.REAL_SETLE_AMOUNT
		     , A.USE_POINT
		     , DECODE(A.DELETE_AT, 'Y', 0, A.REAL_SETLE_AMOUNT) SETLE_AMOUNT
		     , DECODE(A.DELETE_AT, 'Y', 0, A.USE_POINT) SETLE_POINT
		     , A.PYMNT_SE
		     , (SELECT X.CODE_NM FROM TB_CMMN_DETAIL_CODE X WHERE X.CODE_ID = 'COM006' AND X.CODE = A.PYMNT_SE) PYMNT_SE_NM
		     , A.TOURIST_NM
		     , A.TOURIST_CTTPC
		     , A.DELETE_AT
		     , DECODE(A.DELETE_AT, 'Y', '구매취소', 'N', '구매') DELETE_AT_NM
		     , TO_CHAR(A.DELETE_DT, 'YYYY-MM-DD HH24:MI:SS') DELETE_DT
		     , (SELECT GOODS_NM
		          FROM TB_PURCHS_GOODS X
		             , TB_CART_GOODS Y
		             , TB_GOODS Z
		         WHERE A.PURCHS_SN = X.PURCHS_SN
		           AND X.CART_SN = Y.CART_SN
		           AND Y.GOODS_CODE = Z.GOODS_CODE
		           AND ROWNUM = 1) GOODS_NM
		     , (SELECT COUNT(1)-1
		          FROM TB_PURCHS_GOODS X
		             , TB_CART_GOODS Y
		         WHERE A.PURCHS_SN = X.PURCHS_SN
		           AND X.CART_SN = Y.CART_SN) GOODS_CNT
		  FROM TB_PURCHS A ]]>
		<include refid="PurchsDAO.whereForSelectPurchsList"/>
		<include refid="PurchsDAO.pagingQueryEnd"/>
	</select>

</sqlMap>